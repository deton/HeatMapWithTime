<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<style>html, body {width: 100%;height: 100%;margin: 0;padding: 0;}</style>
<style>#map {position:absolute;top:0;bottom:0;right:0;left:0;}</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<meta name="viewport" content="width=device-width,
    initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<style>
#toolbar {
    position: absolute;
    top: 5px;
    left: 60px;
    z-index: 1000;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/iso8601-js-period@0.2.1/iso8601.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/pa7_hm.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/pa7_leaflet_hm.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.control.css"/>
<script>
// https://github.com/python-visualization/folium/blob/553a33981fa29a9d4ce6c426563749188906610f/folium/plugins/heat_map_withtime.py#L217
var TDHeatmap = L.TimeDimension.Layer.extend({
    initialize: function(data, options) {
        var heatmapCfg = {
            radius: 15,
            blur: 0.8,
            maxOpacity: 1.,
            scaleRadius: false,
            useLocalExtrema: false,
            latField: 'lat',
            lngField: 'lng',
            valueField: 'count',
            defaultWeight : 1,
        };
        heatmapCfg = L.extend({}, heatmapCfg, options.heatmapOptions || {});
        var layer = new HeatmapOverlay(heatmapCfg);
        L.TimeDimension.Layer.prototype.initialize.call(this, layer, options);
        this._currentLoadedTime = 0;
        this._currentTimeData = {
            data: []
        };
        this.data= data;
        this.defaultWeight = heatmapCfg.defaultWeight || 1;
    },
    onAdd: function(map) {
        L.TimeDimension.Layer.prototype.onAdd.call(this, map);
        map.addLayer(this._baseLayer);
        if (this._timeDimension) {
            this._getDataForTime(this._timeDimension.getCurrentTime());
        }
    },
    _onNewTimeLoading: function(ev) {
        this._getDataForTime(ev.time);
        return;
    },
    isReady: function(time) {
        return (this._currentLoadedTime == time);
    },
    _update: function() {
        this._baseLayer.setData(this._currentTimeData);
        return true;
    },
    _getDataForTime: function(time) {
        delete this._currentTimeData.data;
        this._currentTimeData.data = [];
        var data = this.data[time-1];
        for (var i = 0; i < data.length; i++) {
            this._currentTimeData.data.push({
                lat: data[i][0],
                lng: data[i][1],
                count: data[i].length>2 ? data[i][2] : this.defaultWeight
            });
        }
        this._currentLoadedTime = time;
        if (this._timeDimension && time == this._timeDimension.getCurrentTime() && !this._timeDimension.isLoading()) {
            this._update();
        }
        this.fire('timeload', {
            time: time
        });
    }
});

L.Control.TimeDimensionCustom = L.Control.TimeDimension.extend({
    initialize: function(index, options) {
        var playerOptions = {
            buffer: 1,
            minBufferReady: -1
        };
        options.playerOptions = L.extend({}, playerOptions, options.playerOptions || {});
        L.Control.TimeDimension.prototype.initialize.call(this, options);
        this.index = index;
    },
    _getDisplayDateFormat: function(date){
        return this.index[date.getTime()-1];
    }
});
</script>
</head>
<body>
<div id="map"></div>
<div id="toolbar" class="leaflet-control">
    Import data: <input type="file" id="fileElem" accept=".json" />
</div>
</body>
<script>
var map = L.map('map');
L.tileLayer('https://tile.openstreetmap.jp/styles/osm-bright/{z}/{x}/{y}.png', {
    attribution: '<a href="https://www.openmaptiles.org/" target="_blank">&copy; OpenMapTiles</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>'
}).addTo(map);

/*
// from example9.js of Leaflet.TimeDimension
// start of TimeDimension manual instantiation
var timeDimension = new L.TimeDimension({
    period: "PT5M",
});
// helper to share the timeDimension object between all layers
map.timeDimension = timeDimension; 
// otherwise you have to set the 'timeDimension' option on all layers.

var player = new L.TimeDimension.Player({
    transitionTime: 100, 
    loop: false,
    startOver:true
}, timeDimension);

var timeDimensionControlOptions = {
    player:        player,
    timeDimension: timeDimension,
    position:      'bottomleft',
    autoPlay:      true,
    minSpeed:      1,
    speedStep:     0.5,
    maxSpeed:      15,
    timeSliderDragUpdate: true
};

var timeDimensionControl = new L.Control.TimeDimension(timeDimensionControlOptions);
map.addControl(timeDimensionControl);
*/

const fileInput = document.getElementById("fileElem");
fileElem.addEventListener("change", () => {
    const [file] = fileElem.files;
    if (file) {
        file.text().then(text => {
            loadData(JSON.parse(text));
        }).catch(console.error);
    }
    //fileElem.value = '';
});

let heatmapPlayer;
let heatmapControl;
let heatmapLayer;

function loadData(data) {
    if (heatmapControl) {
        heatmapControl._player.stop();
        heatmapControl.remove();
    }
    map.timeDimension = L.timeDimension({
        times: data.times.map((_, idx) => idx + 1),
        currentTime: new Date(1)
    });

    //heatmapPlayer = new L.TimeDimension.Player({
    //}, map.timeDimension);

    //const times = data.times.map(x => (new Date(x * 1000)).toISOString());
    heatmapControl = new L.Control.TimeDimensionCustom(data.times, {
        //player: heatmapPlayer,
    }).addTo(map);

    if (heatmapLayer) {
        heatmapLayer.remove();
    }
    map.fitBounds(L.latLngBounds(data.latLonWeights[0].map(latLonWeight => latLonWeight.slice(0, 2))));
    heatmapLayer = new TDHeatmap(data.latLonWeights, {
        heatmapOptions: {
        }
    }).addTo(map);
}

</script>
</html>
